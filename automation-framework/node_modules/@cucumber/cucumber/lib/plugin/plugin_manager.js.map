{"version":3,"file":"plugin_manager.js","sourceRoot":"","sources":["../../src/plugin/plugin_manager.ts"],"names":[],"mappings":";;;AAgBA,MAAa,aAAa;IAChB,QAAQ,GAAoB;QAClC,OAAO,EAAE,EAAE;QACX,eAAe,EAAE,EAAE;QACnB,gBAAgB,EAAE,EAAE;QACpB,eAAe,EAAE,EAAE;KACpB,CAAA;IACO,UAAU,GAAoB,EAAE,CAAA;IAEhC,KAAK,CAAC,QAAQ,CACpB,KAAQ,EACR,OAAyC;QAEzC,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,CAAA;IACpC,CAAC;IAED,KAAK,CAAC,IAAI,CACR,SAAoB,EACpB,MAAmC,EACnC,OAAoB,EACpB,MAAe,EACf,WAAsC;QAEtC,MAAM,SAAS,GAAG,MAAM,MAAM,CAAC,WAAW,CAAC;YACzC,SAAS;YACT,EAAE,EAAE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC;YAC5B,OAAO;YACP,MAAM;YACN,WAAW;SACZ,CAAC,CAAA;QACF,IAAI,OAAO,SAAS,KAAK,UAAU,EAAE;YACnC,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,CAAA;SAChC;IACH,CAAC;IAED,IAAI,CACF,KAAQ,EACR,KAAsC;QAEtC,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,CAAA;IAC3D,CAAC;IAED,KAAK,CAAC,SAAS,CACb,KAAQ,EACR,KAAsC;QAEtC,IAAI,WAAW,GAAG,KAAK,CAAA;QACvB,KAAK,MAAM,OAAO,IAAI,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE;YAC1C,MAAM,QAAQ,GAAG,MAAM,OAAO,CAAC,WAAW,CAAC,CAAA;YAC3C,IAAI,OAAO,QAAQ,KAAK,WAAW,EAAE;gBACnC,WAAW,GAAG,QAAQ,CAAA;aACvB;SACF;QACD,OAAO,WAAW,CAAA;IACpB,CAAC;IAED,KAAK,CAAC,OAAO;QACX,KAAK,MAAM,SAAS,IAAI,IAAI,CAAC,UAAU,EAAE;YACvC,MAAM,SAAS,EAAE,CAAA;SAClB;IACH,CAAC;CACF;AA7DD,sCA6DC","sourcesContent":["import { IRunEnvironment } from '../api'\nimport { ILogger } from '../logger'\nimport {\n  CoordinatorPluginEventHandler,\n  InternalPlugin,\n  PluginCleanup,\n  CoordinatorPluginEventValues,\n  CoordinatorPluginEventKey,\n  CoordinatorPluginTransformEventKey,\n  Operation,\n} from './types'\n\ntype HandlerRegistry = {\n  [K in CoordinatorPluginEventKey]: Array<CoordinatorPluginEventHandler<K>>\n}\n\nexport class PluginManager {\n  private handlers: HandlerRegistry = {\n    message: [],\n    'paths:resolve': [],\n    'pickles:filter': [],\n    'pickles:order': [],\n  }\n  private cleanupFns: PluginCleanup[] = []\n\n  private async register<K extends CoordinatorPluginEventKey>(\n    event: K,\n    handler: CoordinatorPluginEventHandler<K>\n  ) {\n    this.handlers[event].push(handler)\n  }\n\n  async init<OptionsType>(\n    operation: Operation,\n    plugin: InternalPlugin<OptionsType>,\n    options: OptionsType,\n    logger: ILogger,\n    environment: Required<IRunEnvironment>\n  ) {\n    const cleanupFn = await plugin.coordinator({\n      operation,\n      on: this.register.bind(this),\n      options,\n      logger,\n      environment,\n    })\n    if (typeof cleanupFn === 'function') {\n      this.cleanupFns.push(cleanupFn)\n    }\n  }\n\n  emit<K extends CoordinatorPluginEventKey>(\n    event: K,\n    value: CoordinatorPluginEventValues[K]\n  ): void {\n    this.handlers[event].forEach((handler) => handler(value))\n  }\n\n  async transform<K extends CoordinatorPluginTransformEventKey>(\n    event: K,\n    value: CoordinatorPluginEventValues[K]\n  ): Promise<CoordinatorPluginEventValues[K]> {\n    let transformed = value\n    for (const handler of this.handlers[event]) {\n      const returned = await handler(transformed)\n      if (typeof returned !== 'undefined') {\n        transformed = returned\n      }\n    }\n    return transformed\n  }\n\n  async cleanup(): Promise<void> {\n    for (const cleanupFn of this.cleanupFns) {\n      await cleanupFn()\n    }\n  }\n}\n"]}